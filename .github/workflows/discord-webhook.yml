name: GitHub All Events to Discord

on:
    # Î™®Îì† Ïù¥Î≤§Ìä∏ Í∞êÏßÄ
    push:
    pull_request:
    issues:
    issue_comment:
    delete:
    release:
    workflow_run:
        workflows: ["*"]
        types:
            - completed

jobs:
    discordNotification:
        runs-on: ubuntu-latest
        steps:
            - name: Send message to Discord
              env:
                  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
              run: |
                  EVENT_TYPE="${{ github.event_name }}"
                  REPO_NAME="${{ github.repository }}"
                  ACTOR="${{ github.actor }}"

                  # Í∏∞Î≥∏ Î©îÏãúÏßÄ
                  MESSAGE=$(cat <<-EOF
                  üì¢ **GitHub Ïù¥Î≤§Ìä∏ Î∞úÏÉù**
                  üîî Ïù¥Î≤§Ìä∏ ÌÉÄÏûÖ: ${EVENT_TYPE}
                  üìå Î†àÌè¨ÏßÄÌÜ†Î¶¨: ${REPO_NAME}
                  üë§ Ïã§ÌñâÏûê: ${ACTOR}
                  EOF
                  )

                  if [[ "$EVENT_TYPE" == "push" ]]; then
                    COMMIT_LIST=""
                    COMMITS_JSON=$(echo '${{ toJson(github.event.commits) }}' | jq -c '.')

                    echo "DEBUG: COMMITS_JSON = $COMMITS_JSON"
                    echo "$COMMITS_JSON" | jq .

                    echo "$COMMITS_JSON" | jq -c '.[]' | while IFS= read -r commit; do
                      COMMIT_MESSAGE=$(echo "$commit" | jq -r '.message')
                      COMMIT_URL=$(echo "$commit" | jq -r '.url')
                      COMMIT_AUTHOR=$(echo "$commit" | jq -r '.author.name')

                      echo "DEBUG: COMMIT_MESSAGE = $COMMIT_MESSAGE"
                      echo "DEBUG: COMMIT_URL = $COMMIT_URL"
                      echo "DEBUG: COMMIT_AUTHOR = $COMMIT_AUTHOR"
                      echo "DEBUG: COMMIT_LIST = $COMMIT_LIST"

                      COMMIT_LIST="${COMMIT_LIST}\nüìù $COMMIT_MESSAGE - üë§ $COMMIT_AUTHOR\nüîó [Ïª§Î∞ã Î≥¥Í∏∞]($COMMIT_URL)"
                    done


                    if [[ -n "$COMMIT_LIST" ]]; then
                      MESSAGE="$MESSAGE\n\nüîÑ **Ìë∏ÏãúÎêú Ïª§Î∞ã Î™©Î°ù:**$COMMIT_LIST"
                    else
                      MESSAGE="$MESSAGE\n\nüîÑ **Ìë∏ÏãúÎêú Ïª§Î∞ãÏù¥ ÏóÜÏäµÎãàÎã§.**"
                    fi
                  fi

                  if [[ "$EVENT_TYPE" == "pull_request" ]]; then
                    PR_TITLE="${{ github.event.pull_request.title }}"
                    PR_URL="${{ github.event.pull_request.html_url }}"
                    PR_STATE="${{ github.event.pull_request.state }}"
                    PR_AUTHOR="${{ github.event.pull_request.user.login }}"

                    MESSAGE="$MESSAGE\n\nüîÄ **Pull Request Ïù¥Î≤§Ìä∏ Î∞úÏÉù**"
                    MESSAGE="$MESSAGE\nüìå **PR Ï†úÎ™©:** $PR_TITLE"
                    MESSAGE="$MESSAGE\nüë§ **ÏûëÏÑ±Ïûê:** $PR_AUTHOR"
                    MESSAGE="$MESSAGE\nüìå **ÏÉÅÌÉú:** $PR_STATE"
                    MESSAGE="$MESSAGE\nüîó [PR Î≥¥Í∏∞]($PR_URL)"
                  fi

                  # JSON Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (Here Document ÏÇ¨Ïö©)
                  PAYLOAD=$(jq -n \
                    --arg username "GitHub Webhook" \
                    --arg content "$(echo -e "$MESSAGE")" \
                    '{username: $username, content: $content}')

                  # Discord ÏõπÌõÖ ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
                  curl -H "Content-Type: application/json" \
                       -X POST \
                       -d "$PAYLOAD" \
                       "$DISCORD_WEBHOOK_URL"
